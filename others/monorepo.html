<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" href="/BFE-Learning/favicon.ico" type="image/x-icon"><title>Monorepo 下的模块包设计实践 | Gadget Docs</title><meta name="description" content="Study N Stops">
    <link rel="modulepreload" href="/BFE-Learning/assets/app.fb35af60.js"><link rel="modulepreload" href="/BFE-Learning/assets/monorepo.html.b5d59582.js"><link rel="modulepreload" href="/BFE-Learning/assets/monorepo.html.bb282368.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.92d18969.js"><link rel="prefetch" href="/BFE-Learning/assets/guide.html.95a5ed3c.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.4e3559d5.js"><link rel="prefetch" href="/BFE-Learning/assets/react-senior.html.581fd023.js"><link rel="prefetch" href="/BFE-Learning/assets/this.html.c93e6016.js"><link rel="prefetch" href="/BFE-Learning/assets/vue_base.html.582d6adf.js"><link rel="prefetch" href="/BFE-Learning/assets/nginx.html.f3451f6e.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.1fd97417.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.107e4554.js"><link rel="prefetch" href="/BFE-Learning/assets/basic.html.6f347dff.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.2ffb43fa.js"><link rel="prefetch" href="/BFE-Learning/assets/context.html.3acd1995.js"><link rel="prefetch" href="/BFE-Learning/assets/event.html.3330a231.js"><link rel="prefetch" href="/BFE-Learning/assets/function.html.7a3b3226.js"><link rel="prefetch" href="/BFE-Learning/assets/handy1.html.6f7b904e.js"><link rel="prefetch" href="/BFE-Learning/assets/promise.html.1819a23a.js"><link rel="prefetch" href="/BFE-Learning/assets/proto.html.a95edb81.js"><link rel="prefetch" href="/BFE-Learning/assets/worker.html.a38fac28.js"><link rel="prefetch" href="/BFE-Learning/assets/404.html.ee82e9f1.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.a6222171.js"><link rel="prefetch" href="/BFE-Learning/assets/guide.html.3b43a946.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.c933315c.js"><link rel="prefetch" href="/BFE-Learning/assets/react-senior.html.55b9296e.js"><link rel="prefetch" href="/BFE-Learning/assets/this.html.9d5b4ebb.js"><link rel="prefetch" href="/BFE-Learning/assets/vue_base.html.250fb782.js"><link rel="prefetch" href="/BFE-Learning/assets/nginx.html.c064f0d1.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.c84343b3.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.f050f6a6.js"><link rel="prefetch" href="/BFE-Learning/assets/basic.html.1123fc73.js"><link rel="prefetch" href="/BFE-Learning/assets/index.html.3ca43af3.js"><link rel="prefetch" href="/BFE-Learning/assets/context.html.213801ae.js"><link rel="prefetch" href="/BFE-Learning/assets/event.html.3c963036.js"><link rel="prefetch" href="/BFE-Learning/assets/function.html.40aa194e.js"><link rel="prefetch" href="/BFE-Learning/assets/handy1.html.f5864d4b.js"><link rel="prefetch" href="/BFE-Learning/assets/promise.html.6a999835.js"><link rel="prefetch" href="/BFE-Learning/assets/proto.html.6b0ee944.js"><link rel="prefetch" href="/BFE-Learning/assets/worker.html.20105362.js"><link rel="prefetch" href="/BFE-Learning/assets/404.html.b92710d7.js"><link rel="prefetch" href="/BFE-Learning/assets/404.0ea6fcd4.js"><link rel="prefetch" href="/BFE-Learning/assets/Layout.468ccae5.js">
    <link rel="stylesheet" href="/BFE-Learning/assets/style.f85b0810.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/BFE-Learning/" class=""><img class="logo" src="/BFE-Learning/logo.jpg" alt="Gadget Docs"><span class="site-name can-hide">Gadget Docs</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="通用"><span class="title">通用</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="通用"><span class="title">通用</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/common/network/" class="" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/common/browser/" class="" aria-label="浏览器"><!--[--><!--]--> 浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/common/safe/" class="" aria-label="安全"><!--[--><!--]--> 安全 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="前端基础"><span class="title">前端基础</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="前端基础"><span class="title">前端基础</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/front/js/context" class="" aria-label="JS基础"><!--[--><!--]--> JS基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/front/css" class="" aria-label="CSS基础"><!--[--><!--]--> CSS基础 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="[React]"><span class="title">[React]</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="[React]"><span class="title">[React]</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/framework/react/" class="" aria-label="react"><!--[--><!--]--> react <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="全栈"><span class="title">全栈</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="全栈"><span class="title">全栈</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/fullstack/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/fullstack/module/" class="" aria-label="模块化"><!--[--><!--]--> 模块化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/fullstack/webpack/" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据+算法"><span class="title">数据+算法</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据+算法"><span class="title">数据+算法</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/data/desgin/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/data/structure/" class="" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/data/algorithm/" class="" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="其他"><span class="title">其他</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="其他"><span class="title">其他</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/others/nginx" class="" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/steven7sheng/BFE-Learning" rel="noopener noreferrer" target="_blank" aria-label="Repo"><!--[--><!--]--> Repo <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="通用"><span class="title">通用</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="通用"><span class="title">通用</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/common/network/" class="" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/common/browser/" class="" aria-label="浏览器"><!--[--><!--]--> 浏览器 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/common/safe/" class="" aria-label="安全"><!--[--><!--]--> 安全 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="前端基础"><span class="title">前端基础</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="前端基础"><span class="title">前端基础</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/front/js/context" class="" aria-label="JS基础"><!--[--><!--]--> JS基础 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/front/css" class="" aria-label="CSS基础"><!--[--><!--]--> CSS基础 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="[React]"><span class="title">[React]</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="[React]"><span class="title">[React]</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/framework/react/" class="" aria-label="react"><!--[--><!--]--> react <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="全栈"><span class="title">全栈</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="全栈"><span class="title">全栈</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/fullstack/node/" class="" aria-label="Node"><!--[--><!--]--> Node <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/fullstack/module/" class="" aria-label="模块化"><!--[--><!--]--> 模块化 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/fullstack/webpack/" class="" aria-label="webpack"><!--[--><!--]--> webpack <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="数据+算法"><span class="title">数据+算法</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="数据+算法"><span class="title">数据+算法</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/data/desgin/" class="" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/data/structure/" class="" aria-label="数据结构"><!--[--><!--]--> 数据结构 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/BFE-Learning/data/algorithm/" class="" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="其他"><span class="title">其他</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="其他"><span class="title">其他</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/BFE-Learning/others/nginx" class="" aria-label="Nginx"><!--[--><!--]--> Nginx <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/steven7sheng/BFE-Learning" rel="noopener noreferrer" target="_blank" aria-label="Repo"><!--[--><!--]--> Repo <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html" class="router-link-active router-link-exact-active router-link-active sidebar-item sidebar-heading active" aria-label="Monorepo 下的模块包设计实践"><!--[--><!--]--> Monorepo 下的模块包设计实践 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#前言" class="router-link-active router-link-exact-active sidebar-item" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#为什么设计模块包" class="router-link-active router-link-exact-active sidebar-item" aria-label="为什么设计模块包？"><!--[--><!--]--> 为什么设计模块包？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#有哪些类型的模块包" class="router-link-active router-link-exact-active sidebar-item" aria-label="有哪些类型的模块包？"><!--[--><!--]--> 有哪些类型的模块包？ <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#package-json-模块声明" class="router-link-active router-link-exact-active sidebar-item" aria-label="package.json 模块声明"><!--[--><!--]--> package.json 模块声明 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#version" class="router-link-active router-link-exact-active sidebar-item" aria-label="version"><!--[--><!--]--> version <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#dependencies-dev-peer" class="router-link-active router-link-exact-active sidebar-item" aria-label="dependencies, dev, peer"><!--[--><!--]--> dependencies, dev, peer <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#private" class="router-link-active router-link-exact-active sidebar-item" aria-label="private"><!--[--><!--]--> private <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#模块类型" class="router-link-active router-link-exact-active sidebar-item" aria-label="模块类型"><!--[--><!--]--> 模块类型 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#单入口-main-module-browser" class="router-link-active router-link-exact-active sidebar-item" aria-label="单入口（main, module, browser）"><!--[--><!--]--> 单入口（main, module, browser） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#多入口-exports-browser" class="router-link-active router-link-exact-active sidebar-item" aria-label="多入口（exports, browser）"><!--[--><!--]--> 多入口（exports, browser） <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#怎样设计模块包" class="router-link-active router-link-exact-active sidebar-item" aria-label="怎样设计模块包？"><!--[--><!--]--> 怎样设计模块包？ <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#共享配置模块-packages-shared" class="router-link-active router-link-exact-active sidebar-item" aria-label="共享配置模块（packages/shared）"><!--[--><!--]--> 共享配置模块（packages/shared） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#组件库-ui-模块-packages-ui" class="router-link-active router-link-exact-active sidebar-item" aria-label="组件库 UI 模块（packages/ui）"><!--[--><!--]--> 组件库 UI 模块（packages/ui） <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#原生语言模块-packages-native" class="router-link-active router-link-exact-active sidebar-item" aria-label="原生语言模块（packages/native）"><!--[--><!--]--> 原生语言模块（packages/native） <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#总结" class="router-link-active router-link-exact-active sidebar-item" aria-label="总结"><!--[--><!--]--> 总结 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/BFE-Learning/others/monorepo.html#参考" class="router-link-active router-link-exact-active sidebar-item" aria-label="参考"><!--[--><!--]--> 参考 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="monorepo-下的模块包设计实践" tabindex="-1"><a class="header-anchor" href="#monorepo-下的模块包设计实践" aria-hidden="true">#</a> Monorepo 下的模块包设计实践</h1><blockquote><p>ref: <a href="https://www.rustc.cloud/monorepo-pkg" target="_blank" rel="noopener noreferrer">https://www.rustc.cloud/monorepo-pkg<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>本文主要面向业务中使用<strong>Monorepo</strong>组织<strong>应用和模块</strong>，抛砖引玉探讨下：</p><ul><li>怎样设计一个<strong>共享配置包</strong>（配置、类型、utils、枚举），同时在前端、Node.js、Vite 等项目中使用</li><li><s>组件库 UI 模块（packages/ui）</s></li><li><s>原生语言模块（packages/native）</s></li></ul><p>原文演示的代码仓库见：<a href="https://github.com/ycjcl868/monorepo" target="_blank" rel="noopener noreferrer">monorepo<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>（使用 pnpm，其它 Monorepo 工具同理）</p><h2 id="为什么设计模块包" tabindex="-1"><a class="header-anchor" href="#为什么设计模块包" aria-hidden="true">#</a> 为什么设计模块包？</h2><p>随着<strong>Monorepo</strong>代码越堆越多、多人员协作情况下，不可避免遇到如下问题：</p><ul><li><strong>重复定义问题</strong>：工具方法、类型、配置在不同应用之间<strong>重复定义</strong>，维护困难。（例如：一个应用类型<code>AppType</code>的定义可以达<em>10多处</em>，很多还是<em>旧的定义</em>；项目用到配置；<code>tsconfig.json</code> 、prettier 等相同的配置写一遍又一遍）</li></ul><p><img src="/BFE-Learning/assets/duplicate-define.1c3b2a24.png" alt="dup-def"></p><ul><li><p><strong>依赖管理问题</strong>：为解决重用问题，我们也试过将模块先发成 npm 包，但发完需要<strong>更新</strong>应用 package.json 中的<strong>依赖版本</strong>，一来一回非常折腾。</p></li><li><p><strong>跨项目使用问题</strong>：同构就是指 <strong>模块同时跑在前后端项目</strong>，兼容不同的<strong>模块包规范</strong>（CommonJS、ESM 等）。如果没有很好的设计包结构，经常会在项目<strong>编译打包时报错</strong> ❌。</p></li></ul><p><img src="/BFE-Learning/assets/build-error.343ad5a8.png" alt="build-err"></p><h2 id="有哪些类型的模块包" tabindex="-1"><a class="header-anchor" href="#有哪些类型的模块包" aria-hidden="true">#</a> 有哪些类型的模块包？</h2><p>由于历史原因，JavaScript 模块化系统一直没有统一规范，大致发展过程是：CJS → AMD → CMD → UMD → ESM，这给设计一个<strong>跨应用使用的模块</strong>带来不少麻烦。 在设计模块包之前，有必要先了解下目前主流的模块类型和规范（esm、cjs、umd）。</p><div class="custom-container tip"><p class="custom-container-title">ESM（ES Modules）</p><p>JavaScript 官方的标准化模块系统（草案），在标准化道路上花了近 10 年时间。 适用于：</p><ul><li>Browser</li><li>Node.js ≥ 12.17</li></ul><h4 id="导出语法-使用语法" tabindex="-1"><a class="header-anchor" href="#导出语法-使用语法" aria-hidden="true">#</a> 导出语法 &amp;&amp; 使用语法</h4><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">export</span> <span class="token keyword">default</span> foo
<span class="token keyword">export</span> <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> bar <span class="token keyword">as</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;&#39;</span>

<span class="token keyword">import</span> foo <span class="token keyword">from</span> <span class="token string">&#39;name&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;name&#39;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token keyword">as</span> bar <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;name&#39;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>.<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>module<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">
import { bar } from &#39;name&#39;;
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>JS 标准，优先考虑使用该模块 Tree Shaking 友好</p></div><div class="custom-container tip"><p class="custom-container-title">CJS（CommonJS）</p><p>Node.js 的模块标准，文件即模块。 适用于：</p><ul><li>Node.js</li></ul><h4 id="导出语法-使用语法-1" tabindex="-1"><a class="header-anchor" href="#导出语法-使用语法-1" aria-hidden="true">#</a> 导出语法 &amp;&amp; 使用语法</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> foo
exports<span class="token punctuation">.</span>foo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对 Tree Shaking 不友好 前端也可以使用 cjs 格式，依靠构建工具（webpack / rollup 等）</p></div><div class="custom-container tip"><p class="custom-container-title">UMD（Universal Module Definition）</p><p>umd 严格意义上不算规范，只是社区出的通用包模块结合体的格式，兼容 CJS 和 AMD 格式。 浏览器端用来挂载全局变量 （如：window.*） 适用于：</p><ul><li>Browser（external 场景）</li><li>Node.js（较少）</li></ul><h4 id="导出语法-使用语法-2" tabindex="-1"><a class="header-anchor" href="#导出语法-使用语法-2" aria-hidden="true">#</a> 导出语法 &amp;&amp; 使用语法</h4><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">root<span class="token punctuation">,</span> factory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">// amd) {</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token comment">//cjs) {</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">(</span><span class="token comment">//global)  {</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
window<span class="token punctuation">.</span>React
window<span class="token punctuation">.</span>ReactDOM
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>通过上面模块的对比，对于现阶段选择模块规范的<strong>最佳实践</strong>是：</p><ul><li>共享配置模块（跨前后端）：同时打出 ESM、CJS 格式的包（目前 Node.js 运行时对 ESM 支持不是很好）</li><li>UI 组件库：同时打出 ESM、CJS、UMD（umd 主要是为了让前端项目可以做 external，减少构建时长）</li><li>面向 Node.js 项目：目前只需要打出 CJS 格式</li></ul><h2 id="package-json-模块声明" tabindex="-1"><a class="header-anchor" href="#package-json-模块声明" aria-hidden="true">#</a> package.json 模块声明</h2><p>如果模块设计是一门艺术，<code>package.json</code> 就是这门艺术的说明书！在实际开发过程中，有不少开发者并不能正确配置 <code>package.json</code>。</p><p>大部分字段来源于 npm 官方 的定义，描述一个包的基础信息：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
    <span class="token comment">// 包名（示例：import {} from &#39;your-lib&#39;）</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;your-lib&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;一句话介绍你的包&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 发布到 npm 上的目录，不同于 `.npmignore` 黑名单，`files` 是白名单</span>
    <span class="token property">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;es&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lib&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 安全神器，不发到 npm 上</span>
    <span class="token property">&quot;private&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 包依赖
     */</span>
    <span class="token comment">// 运行时依赖，包消费者会安装的依赖</span>
    <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;lodash&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.17.21&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// ❌ &quot;webpack&quot;: &quot;^5.0.0&quot;,</span>
        <span class="token comment">// ❌ &quot;react&quot;: &quot;^17.0.0&quot; 不推荐将 react 写进依赖</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;peerDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
       <span class="token property">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.0.0 || ^17.0.0&quot;</span><span class="token punctuation">,</span>
       <span class="token property">&quot;react-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.0.0 || ^17.0.0&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 开发时依赖，使用方不会安装到，只为包开发者服务</span>
    <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;rollup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.60.2&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;eslint&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.5.0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.0.0&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;react-dom&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.0.0&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这里要注意的点：</p><h3 id="version" tabindex="-1"><a class="header-anchor" href="#version" aria-hidden="true">#</a> version</h3><p>遵循 <a href="https://docs.npmjs.com/about-semantic-versioning/" target="_blank" rel="noopener noreferrer">semver<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 语义化版本（<a href="https://semver.npmjs.com/" target="_blank" rel="noopener noreferrer">验证小工具<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>），格式一般为 <code>{major}.{minor}.{patch}</code>。</p><ul><li><code>major</code>：大功能/特性更新、对用户使用方式有影响；</li><li><code>minor</code>：新功能、对用户使用方式无影响；</li><li><code>patch</code>：bug 修复/不影响用户 我们来看几个易错的例子：</li><li>发 alpha/beta 版，1.0.1 版本已发布，发下一个 beta 版： <ul><li>❌ 发 1.0.1-beta.1</li><li>✅ 发 1.0.2-beta.1</li></ul></li><li>^0.x.y 版本匹配问题。例如：用户配置 <code>&quot;^0.9.0&quot;</code>，匹配不了 0.10.0 版本（如下图）。建议正式版从 1.x 开始发版。</li></ul><p><img src="/BFE-Learning/assets/npm-versions.baa61be5.png" alt="npm-versions"></p><h3 id="dependencies-dev-peer" tabindex="-1"><a class="header-anchor" href="#dependencies-dev-peer" aria-hidden="true">#</a> dependencies, dev, peer</h3><p>模块包的依赖，很多模块开发者容易写错的地方。这里用 生产者 表示 模块包开发者，消费者 表示使用模块包的应用</p><ul><li><code>dependencies</code>：<strong>运行时依赖</strong>，模块消费者会安装这里的依赖。不推荐的配置：</li><li>❌ &quot;webpack&quot;: &quot;^5.0.0&quot;，消费者会安装 webpack，除非这个模块包揽 webpack 功能不需要应用安装</li><li>❌ &quot;react&quot;: &quot;^17.0.0&quot;，消费者安装 react 依赖，可能带来 React 多实例问题</li><li><code>devDependencies</code>：<strong>开发时依赖</strong>，消费者不会安装，只为生产者服务。例如： <ul><li>✅ &quot;rollup&quot;: &quot;^2.60.2&quot;</li><li>✅ &quot;webpack&quot;: &quot;^5.0.0&quot;</li><li>✅ &quot;react&quot;: &quot;^17.0.0&quot;</li></ul></li><li><code>peerDependencies</code>：<strong>宿主依赖</strong>，指定了当前模块包在使用前需要安装的依赖，这个配置争议比较大，npm 7 后会默认自动安装依赖，而 pnpm、yarn 目前不会。 <ul><li>✅ &quot;react&quot;: &quot;^16.0.0 || ^17.0.0&quot;</li></ul></li></ul><h3 id="private" tabindex="-1"><a class="header-anchor" href="#private" aria-hidden="true">#</a> private</h3><p>不发布的包，记得设置为 true，避免误操作 npm publish 发到外网造成安全问题。</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># packages/private/package.json</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;private&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

$ <span class="token function">npm</span> publish
<span class="token function">npm</span> ERR<span class="token operator">!</span> code EPRIVATE
<span class="token function">npm</span> ERR<span class="token operator">!</span> This package has been marked as private
<span class="token function">npm</span> ERR<span class="token operator">!</span> Remove the <span class="token string">&#39;private&#39;</span> field from the package.json to publish it.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="模块类型" tabindex="-1"><a class="header-anchor" href="#模块类型" aria-hidden="true">#</a> 模块类型</h3><p>声明当前包属于哪种模块格式（CJS、ESM），不同条件加载不同的模块类型，类型的配置字段源于：</p><ul><li>npm 规范</li><li>Node.js 官方模块加载规范</li><li>Package Exports</li></ul><h3 id="单入口-main-module-browser" tabindex="-1"><a class="header-anchor" href="#单入口-main-module-browser" aria-hidden="true">#</a> 单入口（main, module, browser）</h3><p>如果是单入口包，始终从包名导出 <code>import from &#39;your-lib&#39;</code>，可以按如下配置：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token comment">// -----单入口----</span>
    <span class="token comment">// 入口文件（使用 cjs 规范）</span>
    <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;lib/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 入口文件（使用 esm 规范）</span>
    <span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 包类型导出</span>
    <span class="token property">&quot;typings&quot;</span><span class="token operator">:</span> <span class="token string">&quot;typings/index.d.ts&quot;</span><span class="token punctuation">,</span>
    <span class="token comment">// 浏览器入口</span>
    <span class="token property">&quot;browser&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/index.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参数说明：</p><ul><li><code>main</code>: CJS格式的入口文件</li><li><code>module</code>: ESM 格式的入口文件</li><li><code>browser</code>: 浏览器端使用，配置成 umd 格式（webpack &lt; 5 会优先使用 browser）</li><li><code>sideEffects</code>: 副作用配置，主要用在 <strong>Tree Shaking</strong> 场景，设置成 <code>false</code> 则告诉打包工具大胆进行 <strong>Tree Shaking</strong>。</li></ul><h3 id="多入口-exports-browser" tabindex="-1"><a class="header-anchor" href="#多入口-exports-browser" aria-hidden="true">#</a> 多入口（exports, browser）</h3><p>多入口包，例如 <code>import from &#39;your-lib/react&#39;</code>、<code>import from &#39;your-lib/vue&#39;</code>，推荐配置：</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
     <span class="token comment">// ----多入口---</span>
    <span class="token property">&quot;exports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;./react&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/react/index.js&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;require&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/react/index.cjs&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">&quot;./vue&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">&quot;import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/vue/index.js&quot;</span><span class="token punctuation">,</span>
            <span class="token property">&quot;require&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/vue/index.cjs&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;browser&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;./react&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/react/index.js&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;./vue&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dist/vue/index.js&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>参数说明：</p><ul><li><code>exports</code>：Node.js 提出的模块导出提案，好处是可以定义导出的模块路径，支持不同环境（Node.js、浏览器等）下使用不同格式（esm、cjs）的包</li><li><code>browser</code> 和 <code>sideEffects</code> 含义同上</li></ul><p>对 <code>package.json</code> 了解后，开始从常见的模块包看下如何进行设计。</p><h2 id="怎样设计模块包" tabindex="-1"><a class="header-anchor" href="#怎样设计模块包" aria-hidden="true">#</a> 怎样设计模块包？</h2><p>初始化一个 <strong>Monorepo</strong> 示例项目（包含 apps 和 packages），目录结构如下（其中 apps 包含常见的应用类型）：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code>apps <span class="token comment">#（前端、后端）</span>
 <span class="token punctuation">-</span> deno<span class="token punctuation">-</span>app
 <span class="token punctuation">-</span> next<span class="token punctuation">-</span>app
 <span class="token punctuation">-</span> node<span class="token punctuation">-</span>app
 <span class="token punctuation">-</span> react<span class="token punctuation">-</span>app
 <span class="token punctuation">-</span> umi<span class="token punctuation">-</span>app
 <span class="token punctuation">-</span> vite<span class="token punctuation">-</span>app
 <span class="token punctuation">-</span> vite<span class="token punctuation">-</span>react<span class="token punctuation">-</span>app
packages <span class="token comment">#（模块包）</span>
 <span class="token punctuation">-</span> shared <span class="token comment">#（共享配置模块） - configs</span>
	 <span class="token punctuation">-</span> tsconfig.base.json
	 <span class="token punctuation">-</span> types
	 <span class="token punctuation">-</span> utils
	 <span class="token punctuation">-</span> index.ts
	 <span class="token punctuation">-</span> package.json
 <span class="token punctuation">-</span> ui <span class="token comment">#（组件库） - react</span>
	 <span class="token punctuation">-</span> vue
	 <span class="token punctuation">-</span> package.json
	 <span class="token punctuation">-</span> native <span class="token comment">#（Rust/C++ 原生模块编译成 npm，用在 Node.js）</span>
	 <span class="token punctuation">-</span> src
	 <span class="token punctuation">-</span> lib.rs
	 <span class="token punctuation">-</span> package.json
.npmrc
package.json
pnpm<span class="token punctuation">-</span>workspace.yaml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>每个模块包的设计按照下面的步骤展开介绍：</p><ol><li>应用中如何使用？</li><li>怎么构建？</li><li>怎么配 package.json</li><li>效果展示</li></ol><h3 id="共享配置模块-packages-shared" tabindex="-1"><a class="header-anchor" href="#共享配置模块-packages-shared" aria-hidden="true">#</a> 共享配置模块（packages/shared）</h3><p>现在要解决枚举、配置、工具方法的复用，希望同时在所有项目中可使用</p><h4 id="使用方式" tabindex="-1"><a class="header-anchor" href="#使用方式" aria-hidden="true">#</a> 使用方式</h4><p>应用中的使用如下：</p><ol><li>项目中声明模块的依赖，<code>workspace:*</code> 表示使用当前 <strong>Monorepo</strong> 的 <code>shared</code> 模块包</li></ol><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// apps/*/package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;@infras/shared&quot;</span><span class="token operator">:</span> <span class="token string">&quot;workspace:*&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了更方便地调试 <strong>Monorepo</strong> 包模块，这里我们使用 <code>pnpm workspace</code> 协议（同时 yarn 也支持了这一协议）。 在项目中使用 import 引 esm 格式、require 引 cjs 格式、常用的项目配置 <code>tsconfig.json</code></p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// apps/*/index.{ts,tsx,jsx}</span>
import <span class="token punctuation">{</span> AppType <span class="token punctuation">}</span> from &#39;@infras/shared/types&#39;;
import <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> from &#39;@infras/shared/utils&#39;;

console.log(AppType.Web); <span class="token comment">// 1</span>
console.log(sum(<span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>));   <span class="token comment">// 2</span>

<span class="token comment">// apps/*/index.js</span>
const <span class="token punctuation">{</span> AppType <span class="token punctuation">}</span> = require(&#39;@infras/shared/types&#39;);
const <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> = require(&#39;@infras/shared/utils&#39;);

<span class="token comment">// apps/*/tsconfig.json</span>
<span class="token punctuation">{</span>
 <span class="token property">&quot;extends&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@infras/shared/configs/tsconfig.base.json&quot;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="构建出-esm、cjs-格式" tabindex="-1"><a class="header-anchor" href="#构建出-esm、cjs-格式" aria-hidden="true">#</a> 构建出 ESM、CJS 格式</h4><p>上文讲到过，我们最后同时打出 ESM 和 CJS 格式的包，这样使用方可以按需取用。那么，我们应该用哪个构建工具呢？ 这里可选的编译/打包工具：</p><ul><li>Transformer（编译）：babeljs、TypeScript、esbuild</li><li>Bundler（打包）：Rollup、esbuild、webpack、<strong>tsup</strong>、unbuild</li></ul><p>两者区别：编译（a → a&#39;、b → b&#39;）、打包（ab → c，All in One） 经过实践，这里选择 tsup，可以快速的、方便的、开箱即用的构建出 esm、cjs 格式的包，同时还有类型。 用 <code>tsup</code> 不用 tsc/rollup/babel 的原因：共享配置模块其实只需要 tsc 就可以解决，用不上 rollup 丰富的生态，工具配置多又麻烦。还有一点是编译打包速度上 tsup 更快。 打包配置 <code>tsup.config.ts</code> 如下：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// packages/shared/tsup.config.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;tsup&#39;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;utils/index.ts&#39;</span><span class="token punctuation">,</span> <span class="token string">&quot;types/index.ts&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  clean<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  dts<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  outDir<span class="token operator">:</span> <span class="token string">&quot;dist&quot;</span><span class="token punctuation">,</span>
  format<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;cjs&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;esm&#39;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>执行下 <code>tsup</code> 会生成 <code>dist</code> 目录，结构如下：</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># packages/shared</span>
<span class="token punctuation">-</span> dist
    <span class="token punctuation">-</span> utils
        <span class="token punctuation">-</span> index.js（cjs）
        <span class="token punctuation">-</span> index.mjs（esm）
    <span class="token punctuation">-</span> types
        <span class="token punctuation">-</span> index.js
        <span class="token punctuation">-</span> index.mjs
<span class="token punctuation">-</span> utils
<span class="token punctuation">-</span> types
<span class="token punctuation">-</span> package.json
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注：不将多入口 <code>utils</code>、<code>types</code> 目录放到 <code>src</code> 目的</p><p>是为了在 Monorepo 项目中有<strong>更好的 TS 类型支持</strong>！实际是用了障眼法，将类型提示指向源文件 ts，真正使用的是 dist 产物目录</p></blockquote><h4 id="package-json" tabindex="-1"><a class="header-anchor" href="#package-json" aria-hidden="true">#</a> --package.json</h4><p>通用模块包的 package.json 如下，因为是多入口，这里用 <code>exports</code> 、<code>browser</code>的组合导出了 cjs 和 esm 格式包。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// packages/shared/package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@infras/shared&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.1&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;An infrastructure monorepo shared library for all projects and apps.&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;browser&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;./types&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/types/index.mjs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;./utils&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/utils/index.mjs&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;exports&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;./types&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/types/index.mjs&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;require&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/types/index.js&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;./utils&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;import&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/utils/index.mjs&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;require&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/utils/index.js&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prepare&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build&quot;</span><span class="token punctuation">,</span>  
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsup --watch&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tsup&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;tsup&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.10.3&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>scripts.prepare</code>：给模块包加上 prepare 构建脚本后，执行的时机包括：</p><ul><li>发布前编译（相当于 <code>prepublishOnly</code>）</li><li>本地 npm install 会执行（不同于 <code>postinstall</code> 在任何时候 install 都会执行，会造成消费者 install 时 tsup 依赖不存在报错）</li></ul><blockquote><p>同时在使用 pnpm publish 发包的时候会移除 scripts.prepare（源码实现） <img src="/BFE-Learning/assets/pnpm-publish.39ada972.png" alt="pnpm-publish"></p></blockquote><h4 id="运行" tabindex="-1"><a class="header-anchor" href="#运行" aria-hidden="true">#</a> 运行</h4><p>在前端项目中使用：<code>pnpm start --filter &quot;react-app&quot;</code></p><p>在 Node.js 项目中使用 <code>pnpm start --filter &quot;node-app&quot;</code></p><p>Vite 中使用 <code>pnpm start --filter &quot;vite-app&quot;</code></p><h3 id="组件库-ui-模块-packages-ui" tabindex="-1"><a class="header-anchor" href="#组件库-ui-模块-packages-ui" aria-hidden="true">#</a> 组件库 UI 模块（packages/ui）</h3><div class="custom-container danger"><p class="custom-container-title">略</p><p><a href="https://www.rustc.cloud/monorepo-pkg#edd0f37f3d144842978315f700978d9a" target="_blank" rel="noopener noreferrer">参考原文<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><h3 id="原生语言模块-packages-native" tabindex="-1"><a class="header-anchor" href="#原生语言模块-packages-native" aria-hidden="true">#</a> 原生语言模块（packages/native）</h3><p>有趣的是，我们可以在 <strong>Monorepo</strong> 中使用 Rust / Golang 编写的 npm 包模块，处理一些 CPU 密集型任务。</p><h4 id="使用方式-1" tabindex="-1"><a class="header-anchor" href="#使用方式-1" aria-hidden="true">#</a> 使用方式</h4><p>在 Node.js 应用的使用方式如下： 项目中声明原生语言模块的依赖</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token comment">// apps/node-app/package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
     <span class="token property">&quot;@infras/rs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;workspace:*&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Node.js 中调用：</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// apps/node-app/index.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;@infras/rs&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;Rust \`sum(1, 1)\`:&#39;</span><span class="token punctuation">,</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token comment">// apps/node-app/index.mjs</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@infras/rs&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="构建出-cjs" tabindex="-1"><a class="header-anchor" href="#构建出-cjs" aria-hidden="true">#</a> 构建出 cjs</h4><p>这里使用 napi-rs 初始化一个 Rust 构建的 npm 模块包，napi-rs 并没有构建出 esm 格式的包，而是选择用 cjs 格式来兼容 esm（相关 node#40541）</p><div class="language-yaml ext-yml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># packages/rs</span>
<span class="token punctuation">-</span> src
    <span class="token punctuation">-</span> lib.rs
<span class="token punctuation">-</span> npm
<span class="token punctuation">-</span> index.js
<span class="token punctuation">-</span> index.d.ts
<span class="token punctuation">-</span> package.json
<span class="token punctuation">-</span> Cargo.toml
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="package-json-1" tabindex="-1"><a class="header-anchor" href="#package-json-1" aria-hidden="true">#</a> package.json</h4><p>直接使用 napi-rs 初始化出来的 package.json，无须进行修改即可使用。</p><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@infras/rs&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;commonjs&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;types&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.d.ts&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@napi-rs/cli&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prepare&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;artifacts&quot;</span><span class="token operator">:</span> <span class="token string">&quot;napi artifacts&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;napi build --platform --release&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:debug&quot;</span><span class="token operator">:</span> <span class="token string">&quot;napi build --platform&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;napi version&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="运行-1" tabindex="-1"><a class="header-anchor" href="#运行-1" aria-hidden="true">#</a> 运行</h4><p>Node 项目中 pnpm start --filter &quot;node-app&quot;，这样看 Rust 编译后的函数执行效率比 Node.js 原生快不少（8.44ms → 0.069ms） <img src="/BFE-Learning/assets/rust-time.15d560bc.png" alt="rust-time"></p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>读到这里，想必大家对模块标准有一定的了解，知道一些常见场景下如何进行模块设计，这里做个总结：</p><ul><li><strong>ESM First</strong>：无论什么模块，优先构建出 ESM 格式。多入口包使用 exports 、browser（若 webpack &lt; 5），单入口使用 main、module 可处理大部分模块格式问题</li><li><strong>共享配置模块</strong>（utils、类型、枚举等）使用 tsup 打包工具，生成 ESM、CJS 两种包类型。</li><li><strong>组件库</strong> 通常使用 rollup 打包，生成 ESM、CJS、UMD 三种包类型，同时要注意 React 组件库在版本不一致时的多实例问题</li></ul><h3 id="参考" tabindex="-1"><a class="header-anchor" href="#参考" aria-hidden="true">#</a> 参考</h3><p><a href="https://blog.npmjs.org/post/186494959890/monorepos-and-npm.html" target="_blank" rel="noopener noreferrer">npm Blog Archive: Monorepos and npm<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://blog.csdn.net/qq_21567385/article/details/121088506" target="_blank" rel="noopener noreferrer">pnpm monorepo之多组件实例和peerDependencies困境回溯<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/BFE-Learning/assets/app.fb35af60.js" defer></script>
  </body>
</html>
